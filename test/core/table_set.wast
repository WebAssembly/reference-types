(module
  (table $t1 1 eqref)
  (table $t2 1 anyref)
  (table $t3 2 anyfunc) (elem $t3 (i32.const 1) $dummy)
  (func $dummy)

  (func (export "get-eqref") (param $i i32) (result eqref)
    (table.get $t1 (get_local $i))
  )
  (func (export "get-anyref") (param $i i32) (result anyref)
    (table.get $t2 (get_local $i))
  )
  (func $f3 (export "get-anyfunc") (param $i i32) (result anyfunc)
    (table.get $t3 (get_local $i))
  )

  (func (export "set-eqref") (param $i i32) (param $r eqref)
    (table.set $t1 (get_local $i) (get_local $r))
  )
  (func (export "set-anyref") (param $i i32) (param $r anyref)
    (table.set $t2 (get_local $i) (get_local $r))
  )
  (func (export "set-anyfunc") (param $i i32) (param $r anyfunc)
    (table.set $t3 (get_local $i) (get_local $r))
  )
  (func (export "set-anyfunc-from") (param $i i32) (param $j i32)
    (table.set $t3 (get_local $i) (table.get $t3 (get_local $j)))
  )

  (func (export "isnull-anyfunc") (param $i i32) (result i32)
    (ref.isnull (call $f3 (get_local $i)))
  )
)

(assert_return (invoke "get-eqref" (i32.const 0)) (ref.null))
(assert_return (invoke "set-eqref" (i32.const 0) (ref.host 1)))
(assert_return (invoke "get-eqref" (i32.const 0)) (ref.host 1))
(assert_return (invoke "set-eqref" (i32.const 0) (ref.null)))
(assert_return (invoke "get-eqref" (i32.const 0)) (ref.null))

(assert_return (invoke "get-anyref" (i32.const 0)) (ref.null))
(assert_return (invoke "set-anyref" (i32.const 0) (ref.host 1)))
(assert_return (invoke "get-anyref" (i32.const 0)) (ref.host 1))
(assert_return (invoke "set-anyref" (i32.const 0) (ref.null)))
(assert_return (invoke "get-anyref" (i32.const 0)) (ref.null))

(assert_return (invoke "get-anyfunc" (i32.const 0)) (ref.null))
(assert_return (invoke "set-anyfunc-from" (i32.const 0) (i32.const 1)))
(assert_return (invoke "isnull-anyfunc" (i32.const 0)) (i32.const 0))
(assert_return (invoke "set-anyfunc" (i32.const 0) (ref.null)))
(assert_return (invoke "get-anyfunc" (i32.const 0)) (ref.null))

(assert_trap (invoke "set-eqref" (i32.const 2) (ref.null)) "out of bounds")
(assert_trap (invoke "set-anyref" (i32.const 2) (ref.null)) "out of bounds")
(assert_trap (invoke "set-anyfunc" (i32.const 3) (ref.null)) "out of bounds")
(assert_trap (invoke "set-eqref" (i32.const -1) (ref.null)) "out of bounds")
(assert_trap (invoke "set-anyref" (i32.const -1) (ref.null)) "out of bounds")
(assert_trap (invoke "set-anyfunc" (i32.const -1) (ref.null)) "out of bounds")

(assert_trap (invoke "set-eqref" (i32.const 2) (ref.host 0)) "out of bounds")
(assert_trap (invoke "set-anyref" (i32.const 2) (ref.host 0)) "out of bounds")
(assert_trap (invoke "set-anyfunc-from" (i32.const 3) (i32.const 1)) "out of bounds")
(assert_trap (invoke "set-eqref" (i32.const -1) (ref.host 0)) "out of bounds")
(assert_trap (invoke "set-anyref" (i32.const -1) (ref.host 0)) "out of bounds")
(assert_trap (invoke "set-anyfunc-from" (i32.const -1) (i32.const 1)) "out of bounds")
